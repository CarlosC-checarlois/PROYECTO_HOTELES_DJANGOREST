{% extends "cabezal.html" %}
{% load static %}

{% block titulo_pagina %}
    <title>Mis Pagos | Hotel Gen√©rico</title>
{% endblock %}

{% block css_archivos %}
    <style>
        :root {
            --color-principal: #f97316; /* naranja */
            --color-secundario: #f43f5e; /* coral */
            --color-fondo: #fff7ed; /* fondo c√°lido */
            --color-borde: #fed7aa; /* borde suave */
            --color-texto-suave: #9a3412; /* marr√≥n caf√© */
            --degradado: linear-gradient(135deg, var(--color-secundario), var(--color-principal));
        }

        /* fondo general */
        body {
            background: var(--color-fondo);
        }

        body {
            background: #f5f7fb;
        }

        .pago-card {
            background: #fff;
            border-radius: 1rem;
            padding: 1.5rem;
            transition: .2s;
        }

        .pago-card:hover {
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
            transform: translateY(-3px);
        }

        .badge-estado {
            font-size: 0.85rem;
            padding: .45rem .8rem;
            border-radius: .75rem;
        }

        .small-label {
            font-size: 0.85rem;
        }

        .pdf-link {
            display: inline-block;
            margin-top: 6px;
            font-size: 0.9rem;
            padding: 6px 12px;
            border-radius: 8px;
            background: var(--color-principal);
            color: white;
            text-decoration: none;
            transition: .2s;
        }

        .pdf-link:hover {
            background: var(--color-secundario);
            color: white;
        }
    </style>
{% endblock %}

{% block contenido_pagina %}

    <section class="container py-5">
        <!-- DASHBOARD PAGOS -->
        <div class="row mb-4 g-3" id="dashboard-pagos" style="display:none;">

            <div class="col-md-3">
                <div class="pago-card shadow-sm text-center">
                    <small class="text-muted">Total pagado</small>
                    <h4 id="total-pagado">$0.00</h4>
                </div>
            </div>

            <div class="col-md-3">
                <div class="pago-card shadow-sm text-center">
                    <small class="text-muted">Pagos realizados</small>
                    <h4 id="contador-pagos">0</h4>
                </div>
            </div>

            <div class="col-md-3">
                <div class="pago-card shadow-sm text-center">
                    <small class="text-muted">Cuenta seleccionada</small>
                    <h4 id="cuenta-actual">Todas</h4>
                </div>
            </div>

            <div class="col-md-3">
                <div class="pago-card shadow-sm">
                    <label class="small fw-bold">Filtrar por cuenta</label>
                    <select id="filtro-cuenta" class="form-select">
                        <option value="all">Todas</option>
                    </select>
                </div>
            </div>
            <div class="row mt-4 g-4">
                <div class="col-md-6">
                    <div class="pago-card shadow-sm">
                        <h6 class="fw-bold text-center">Clasificaci√≥n por cuenta (Treemap)</h6>
                        <canvas id="treemapChart"></canvas>
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="pago-card shadow-sm">
                        <h6 class="fw-bold text-center">Pagos en el tiempo (Plot)</h6>
                        <canvas id="chart-line"></canvas>
                    </div>
                </div>
            </div>

        </div>

        <h2 class="fw-bold mb-4">Mis Pagos</h2>

        {% if error %}
            <div class="alert alert-danger">{{ error }}</div>
        {% endif %}

        <div class="row g-4">

            {% for p in pagos %}
                <div class="col-md-6">
                    <div class="pago-card shadow-sm">

                        <!-- Encabezado -->
                        <h5 class="fw-bold mb-1">
                            Pago #{{ p.id }}
                        </h5>

                        <!-- Factura -->
                        <p class="text-muted mb-1">
                            <i class="bi bi-receipt"></i>
                            Factura: {{ p.factura_id }}
                        </p>

                        <!-- Monto -->
                        <p class="mb-1"><strong>Monto:</strong> ${{ p.monto }}</p>

                        <!-- Fecha -->
                        <!-- M√©todo -->
                        <p class="mb-1"><strong>Cuenta origen:</strong> {{ p.cuenta_origen }}</p>
                        <p class="mb-1"><strong>Cuenta destino:</strong> {{ p.cuenta_destino }}</p>


                        <!-- Estado -->
                        {% if p.estado == "Pagado" %}
                            <span class="badge bg-success badge-estado">Pagado</span>
                        {% else %}
                            <span class="badge bg-warning text-dark badge-estado">Pendiente</span>
                        {% endif %}
                        <hr>

                        <p class="fw-bold mb-2">Detalles de la Reserva:</p>

                        {% if p.pdf_url %}
                            <a class="btn btn-primary btn-sm" href="{{ p.pdf_url }}" target="_blank">
                                Ver PDF de la Reserva
                            </a>
                        {% else %}
                            <button class="btn btn-warning btn-sm generar-pdf-btn"
                                    data-factura="{{ p.factura_id }}">
                                Generar PDF
                            </button>
                        {% endif %}


                    </div>
                </div>
            {% endfor %}

        </div>

    </section>

{% endblock %}
{% block bloquear_footer %}
{% endblock %}
{% block jvscript_archivos_defer %}
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-treemap@2.3.1"></script>

    <script>
        // Si el usuario est√° logeado, agregamos ?uid=ID autom√°ticamente
        document.addEventListener("DOMContentLoaded", function () {
            const uid = localStorage.getItem("usuario_id");
            if (uid && window.location.search === "") {
                window.location.href = "?uid=" + uid;
            }
        });
    </script>
    <script>
        document.addEventListener("click", function (e) {
            if (e.target.classList.contains("generar-pdf-btn")) {
                const facturaId = e.target.dataset.factura;

                // Validar que facturaId exista
                if (!facturaId) {
                    alert("Error: No se pudo obtener el ID de la factura.");
                    console.error("facturaId no encontrado en dataset:", e.target.dataset);
                    return;
                }

                // Validar que sea un n√∫mero v√°lido
                const facturaIdNum = parseInt(facturaId);
                if (isNaN(facturaIdNum) || facturaIdNum <= 0) {
                    alert("Error: ID de factura inv√°lido.");
                    return;
                }

                fetch("/api/generar-pdf-reserva/", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": getCookie("csrftoken")
                    },
                    body: JSON.stringify({factura_id: facturaIdNum})
                })
                    .then(r => {
                        if (!r.ok) {
                            return r.json().then(data => {
                                throw new Error(data.error || `Error ${r.status}: ${r.statusText}`);
                            });
                        }
                        return r.json();
                    })
                    .then(data => {
                        if (data.ok) {
                            alert("PDF generado correctamente!");
                            location.reload();
                        } else {
                            alert("Error: " + (data.error || "Error desconocido"));
                        }
                    })
                    .catch(err => {
                        console.error("Error al generar PDF:", err);
                        alert("Error inesperado: " + err.message);
                    });
            }
        });

        // Helper para obtener CSRF token
        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(";").shift();
            return null;
        }

    </script>
    {% comment %}
    CREAR TREEMAP
    {% endcomment %}
    <script>
        function crearTreemap(lista) {

            const canvas = document.getElementById("treemapChart");
            if (!canvas || !Array.isArray(lista) || lista.length === 0) return;

            // =============================
            // FORMATO JER√ÅRQUICO REAL
            // Cuenta -> Transacciones
            // =============================
            const datos = lista.map((p, index) => ({
                cuenta: String(p.cuenta_origen || "Desconocida"),
                transaccion: `Transacci√≥n ${index + 1}`,
                value: Number(p.monto) || 0
            }));

            if (!datos.length) return;

            // =============================
            // DESTRUIR INSTANCIA ANTERIOR
            // =============================
            const prev = Chart.getChart(canvas);
            if (prev) prev.destroy();

            // =============================
            // CREAR TREEMAP
            // =============================
            new Chart(canvas, {
                type: "treemap",
                data: {
                    datasets: [{
                        tree: datos,
                        key: "value",

                        // ‚úÖ JERARQU√çA CORRECTA
                        groups: ["cuenta", "transaccion"],

                        spacing: 2,
                        borderWidth: 2,
                        borderColor: "#ffffff",

                        // üé® COLOR SEGURO
                        backgroundColor(ctx) {
                            const v = ctx.raw?.v ?? 0;
                            const alpha = Math.max(Math.min(v / 120, 1), 0.35);
                            return `rgba(37, 99, 235, ${alpha})`;
                        },

                        // ‚úÖ ETIQUETAS
                        labels: {
                            display: true,
                            formatter(ctx) {
                                const titulo = ctx.raw?.g || "Transacci√≥n";
                                const monto = ctx.raw?.v || 0;
                                return `${titulo}\n$${monto.toFixed(2)}`;
                            },
                            color: "#fff",
                            font: {size: 11, weight: "bold"}
                        }
                    }]
                },
                options: {
                    plugins: {
                        title: {
                            display: true,
                            text: "Distribuci√≥n de transacciones por cuenta bancaria"
                        },
                        legend: {display: false},

                        // ‚úÖ TOOLTIP BLINDADO
                        tooltip: {
                            callbacks: {
                                label(ctx) {

                                    if (!ctx || !ctx.raw) return "";

                                    const transaccion = ctx.raw?.g || "Transacci√≥n";
                                    const cuenta = ctx.raw?.p?.g || "Cuenta";
                                    const valor = ctx.raw?.v || 0;

                                    return `${cuenta} ‚Üí ${transaccion}: $${valor.toFixed(2)}`;
                                }
                            }
                        }
                    }
                }
            });
        }
    </script>
    {% comment %}
    CREAR LINE CHART
    {% endcomment %}
    <script>
        let lineChart = null;

        function crearLinea(lista = []) {

            const canvas = document.getElementById("chart-line");
            if (!canvas) return;

            const datos = lista.filter(p => p.fecha && !isNaN(Date.parse(p.fecha)));

            if (lineChart) lineChart.destroy();

            lineChart = new Chart(canvas, {
                type: "line",
                data: {
                    labels: datos.map(p => p.fecha),
                    datasets: [{
                        label: "Pagos en el tiempo",
                        data: datos.map(p => p.monto),
                        borderColor: "#2563eb",
                        backgroundColor: "rgba(37,99,235,.25)",
                        fill: true,
                        tension: .4
                    }]
                }
            });
        }

    </script>
    {% comment %}
    fech pagos
    {% endcomment %}
    <script>
        async function fetchPagos(uid) {
            try {
                const res = await fetch(`/api/mis-pagos/?uid=${uid}`);
                if (!res.ok) throw new Error("API offline");
                const data = await res.json();
                return Array.isArray(data?.data) ? data.data : [];
            } catch (e) {
                console.error("FETCH ERROR:", e);
                return [];
            }
        }
    </script>
    {% comment %}
    Normalizar datos
    {% endcomment %}
    <script>
        function normalizarPagos(pagos = []) {
            return pagos.map(p => ({
                cuenta_origen: String(p?.cuenta_origen || "Desconocida"),
                monto: Number(p?.monto) || 0,
                fecha: p?.fecha || null,
                estado: p?.estado === "Pagado" ? "Pagado" : "Pendiente"
            }));
        }
    </script>
    {% comment %}
    Render Totales
    {% endcomment %}
    <script>
        function renderTotales(lista = []) {

            const total = lista
                .filter(p => p.estado === "Pagado")
                .reduce((s, p) => s + p.monto, 0);

            const totalEl = document.getElementById("total-pagado");
            const contadorEl = document.getElementById("contador-pagos");

            if (totalEl) totalEl.innerText = `$${total.toFixed(2)}`;
            if (contadorEl) contadorEl.innerText = lista.length;
        }

    </script>
    {% comment %}
    Filtros robustos
    {% endcomment %}
    <script>
        function cargarFiltro(pagos = []) {
            const filtro = document.getElementById("filtro-cuenta");
            const actual = document.getElementById("cuenta-actual");

            const cuentas = [...new Set(pagos.map(p => p.cuenta_origen))];

            cuentas.forEach(c => {
                const opt = document.createElement("option");
                opt.value = c;
                opt.innerText = c;
                filtro.appendChild(opt);
            });

            filtro.addEventListener("change", () => {
                const val = filtro.value;
                const lista = val === "all"
                    ? pagos
                    : pagos.filter(p => p.cuenta_origen === val);

                actual.innerText = val === "all" ? "Todas" : val;
                renderTotales(lista);
                crearTreemap(lista);
                crearLinea(lista);
            });
        }

    </script>


    <script>
        document.addEventListener("DOMContentLoaded", async () => {

            const uid = localStorage.getItem("usuario_id");
            if (!uid) return;

            let pagos = await fetchPagos(uid);
            pagos = normalizarPagos(pagos);

            const dashboard = document.getElementById("dashboard-pagos");

            if (!pagos.length) {
                dashboard.style.display = "none";
                return;
            } else {
                dashboard.style.display = "flex";
            }


            renderTotales(pagos);
            crearTreemap(pagos);
            crearLinea(pagos);
            cargarFiltro(pagos);

        });

    </script>

{% endblock %}
