{% extends "cabezal.html" %}
{% load static %}
{% block bloquear_footer %}
{% endblock %}
{% block css_archivos %}
    <link rel="stylesheet" href="{% static 'webapp/css/usuario/administrador/crud/crud_helper.css' %}">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0/dist/css/select2.min.css" rel="stylesheet"/>
    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/litepicker/dist/css/litepicker.css">

    <style>
        .badge-estado {
            font-size: .85rem;
            padding: .25rem .6rem;
            border-radius: 15px;
        }

        .table-inactive {
            background-color: #e0e0e0 !important;
        }

        .readonly-input {
            background-color: #f0f0f0 !important;
            color: #6c757d !important;
            cursor: not-allowed !important;
        }

        .select2-container {
            width: 100% !important;
        }
    </style>
{% endblock %}

{% block contenido_pagina %}

    <div id="crud-toast-container"></div>

    <div class="container mt-4">

        <!-- HEADER -->
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h2 class="fw-bold">Gestión de Holds (Retenciones de Habitación)</h2>
            <button class="btn btn-primary" onclick="abrirModalCrearHold()">
                <i class="bi bi-plus-lg"></i> Crear Hold
            </button>
        </div>

        <!-- TABLA -->
        <div class="table-responsive shadow-sm">
            <table class="table table-hover align-middle" id="tablaHolds">
                <thead class="table-dark">
                <tr>
                    <th>ID Hold</th>
                    <th>ID Habitación</th>
                    <th>ID Reserva</th>
                    <th>Tiempo (seg)</th>
                    <th>Fecha Inicio</th>
                    <th>Fecha Final</th>
                    <th>Estado</th>
                    <th>Acciones</th>
                </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <!-- PAGINACIÓN -->
        <div class="d-flex justify-content-center align-items-center gap-3 mt-3">
            <button class="btn btn-secondary btn-sm" id="btnAnterior" onclick="irAPaginaAnterior()" disabled>
                ◀ Anterior
            </button>

            <span id="infoPaginacion" class="fw-bold">Cargando...</span>

            <button class="btn btn-secondary btn-sm" id="btnSiguiente" onclick="irAPaginaSiguiente()" disabled>
                Siguiente ▶
            </button>
        </div>

    </div>

    {# MODALES #}
    {% include "webapp/usuario/administrador/crud/hold/modal_crear.html" %}
    {% include "webapp/usuario/administrador/crud/hold/modal_editar.html" %}

{% endblock %}
{% block jvscript_archivos_defer %}
    <script src="{% static 'webapp/js/usuario/administrador/crud/crud_helper.js' %}"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0/dist/js/select2.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/litepicker/dist/litepicker.js"></script>

    <script>
        // ================== CONSTANTES / URLs ==================
        const URL_LIST_HOLD = "/admin/hold/list/";
        const URL_CREATE_HOLD = "/admin/hold/create/";
        const URL_GET_HOLD = id => `/admin/hold/get/${id}/`;
        const URL_UPDATE_HOLD = id => `/admin/hold/update/${id}/`;
        const URL_DELETE_HOLD = id => `/admin/hold/delete/${id}/`;
        const URL_NEXT_HOLD = "/admin/hold/next-id/";

        const URL_SEARCH_HAB = "/admin/habitaciones/search/";
        const URL_SEARCH_RES = "/admin/reservas/search/";

        const MAX_TIEMPO_HOLD = 99999;  // hasta 5 dígitos (minutos)

        let currentPage = 1;
        let totalPages = 1;

        let pickerCrear = null;
        let pickerEditar = null;

        // ================== PAGINACIÓN ==================
        function actualizarPaginacion() {
            $("#btnAnterior").prop("disabled", currentPage <= 1);
            $("#btnSiguiente").prop("disabled", currentPage >= totalPages);
            $("#infoPaginacion").text(`Página ${currentPage} de ${totalPages}`);
        }

        function irAPaginaAnterior() {
            if (currentPage > 1) cargarHolds(currentPage - 1);
        }

        function irAPaginaSiguiente() {
            if (currentPage < totalPages) cargarHolds(currentPage + 1);
        }

        // ================== TABLA ==================
        function cargarHolds(page = 1) {
            currentPage = page;

            $.get(`${URL_LIST_HOLD}?page=${page}`, function (resp) {
                const tbody = $("#tablaHolds tbody");
                tbody.empty();

                const data = resp.data || [];

                data.forEach(h => {
                    const estadoBadge = h.EstadoHold
                        ? `<span class="badge bg-success badge-estado">Activo</span>`
                        : `<span class="badge bg-secondary badge-estado">Inactivo</span>`;

                    const rowClass = h.EstadoHold ? "" : "table-secondary";

                    const btnEliminar = h.EstadoHold
                        ? `<button class="btn btn-danger btn-sm" onclick="eliminarHold('${h.IdHold}')">Eliminar</button>`
                        : `<button class="btn btn-secondary btn-sm" disabled>Eliminado</button>`;

                    const tiempo = (h.TiempoHold !== null && h.TiempoHold !== undefined)
                        ? h.TiempoHold
                        : "N/A";

                    const fIni = h.FechaInicioHold ? h.FechaInicioHold.replace("T", " ") : "N/A";
                    const fFin = h.FechaFinalHold ? h.FechaFinalHold.replace("T", " ") : "N/A";

                    tbody.append(`
                        <tr class="${rowClass}">
                            <td class="fw-bold">${h.IdHold}</td>
                            <td>${h.IdHabitacion}</td>
                            <td>${h.IdReserva}</td>
                            <td>${tiempo}</td>
                            <td>${fIni}</td>
                            <td>${fFin}</td>
                            <td>${estadoBadge}</td>
                            <td>
                                <button class="btn btn-warning btn-sm"
                                        onclick="abrirModalEditarHold('${h.IdHold}')">Editar</button>
                                ${btnEliminar}
                            </td>
                        </tr>
                    `);
                });

                currentPage = resp.page || 1;
                totalPages = resp.total_pages || 1;
                actualizarPaginacion();

            }).fail(xhr => {
                crudNotify("error", xhr.responseJSON?.message || "No se pudo cargar la información de Holds.");
            });
        }

        // ================== SELECT2 (CREAR) ==================
        function initSelectHabitacion(selector, parentSelector) {
            const $sel = $(selector);
            if ($sel.data("select2")) $sel.select2("destroy");
            $sel.val("");

            $sel.select2({
                placeholder: "Buscar habitación...",
                allowClear: true,
                width: "100%",
                dropdownParent: $(parentSelector),
                minimumInputLength: 1,
                ajax: {
                    url: URL_SEARCH_HAB,
                    dataType: "json",
                    delay: 250,
                    data: params => ({q: params.term}),
                    processResults: resp => ({
                        results: (resp.data || []).map(h => ({
                            id: h.IdHabitacion,
                            text: `${h.IdHabitacion} — ${h.NombreHabitacion || ""}`
                        }))
                    })
                }
            });
        }

        function initSelectReserva(selector, parentSelector) {
            const $sel = $(selector);
            if ($sel.data("select2")) $sel.select2("destroy");
            $sel.val("");

            $sel.select2({
                placeholder: "Buscar reserva...",
                allowClear: true,
                width: "100%",
                dropdownParent: $(parentSelector),
                minimumInputLength: 1,
                ajax: {
                    url: URL_SEARCH_RES,
                    dataType: "json",
                    delay: 250,
                    data: params => ({q: params.term}),
                    processResults: resp => ({
                        results: (resp.data || []).map(r => ({
                            id: r.IdReserva,
                            text: `${r.IdReserva} — ${r.EstadoGeneralReserva || ""}`
                        }))
                    })
                }
            });
        }

        // ================== LITEPICKER (RANGO FECHAS) ==================
        function getTodayStr() {
            const d = new Date();
            const month = String(d.getMonth() + 1).padStart(2, "0");
            const day = String(d.getDate()).padStart(2, "0");
            return `${d.getFullYear()}-${month}-${day}`;  // YYYY-MM-DD
        }

        function initRangoFechas(crear = true, start = null, end = null) {
            const inputId = crear ? "crear_RangoFechas" : "editar_RangoFechas";
            const iniHidden = crear ? "#crear_FechaInicio" : "#editar_FechaInicio";
            const finHidden = crear ? "#crear_FechaFinal" : "#editar_FechaFinal";

            const el = document.getElementById(inputId);
            if (!el || !window.Litepicker) return;

            // destruir instancia anterior
            if (crear && pickerCrear) pickerCrear.destroy();
            if (!crear && pickerEditar) pickerEditar.destroy();

            const hoyStr = getTodayStr();

            // CREAR: minDate = hoy
            // EDITAR: minDate = fecha de inicio original (si existe), si no, hoy
            const minDateStr = crear ? hoyStr : (start || hoyStr);
            const startDateStr = start || minDateStr;
            const endDateStr = end || null;

            const picker = new Litepicker({
                element: el,
                singleMode: false,
                format: "YYYY-MM-DD",
                numberOfMonths: 2,
                numberOfColumns: 2,
                autoApply: true,
                minDate: minDateStr,
                startDate: startDateStr,
                endDate: endDateStr,
                tooltipText: {one: "día", other: "días"},
                tooltipNumber: totalDays => totalDays,
                setup: (p) => {
                    p.on("selected", (date1, date2) => {
                        const v1 = date1 ? date1.format("YYYY-MM-DD") : "";
                        const v2 = date2 ? date2.format("YYYY-MM-DD") : "";
                        $(iniHidden).val(v1);
                        $(finHidden).val(v2);
                    });
                }
            });

            if (crear) pickerCrear = picker;
            else pickerEditar = picker;
        }

        // ================== HELPERS TIEMPO HOLD (ENTERO POSITIVO) ==================
        function limpiarTiempoHold(v) {
            if (v == null) return "";
            v = String(v).trim();
            // solo dígitos
            v = v.replace(/[^0-9]/g, "");

            // máximo 5 dígitos
            if (v.length > 5) {
                v = v.slice(0, 5);
            }

            let num = parseInt(v || "0", 10);
            if (isNaN(num) || num <= 0) {
                return "";
            }
            if (num > MAX_TIEMPO_HOLD) {
                num = MAX_TIEMPO_HOLD;
            }
            return String(num);
        }

        function tiempoHoldKeyDown(e) {
            const controlKeys = [
                "Backspace", "Tab", "ArrowLeft", "ArrowRight",
                "Delete", "Home", "End"
            ];
            if (controlKeys.includes(e.key)) return;
            if (e.ctrlKey || e.metaKey) return; // Ctrl+C, Ctrl+V, etc.

            if (!/^[0-9]$/.test(e.key)) {
                e.preventDefault(); // solo dígitos
            }
        }

        function tiempoHoldInput(e) {
            const limpio = limpiarTiempoHold(this.value);
            if (this.value !== limpio) {
                this.value = limpio;
            }
        }

        function tiempoHoldPaste(e) {
            e.preventDefault();
            const txt = (e.clipboardData || window.clipboardData).getData("text");
            this.value = limpiarTiempoHold(txt);
        }

        function configurarTiempoHold() {
            ["crear_TiempoHold", "editar_TiempoHold"].forEach(id => {
                const el = document.getElementById(id);
                if (!el) return;
                el.addEventListener("keydown", tiempoHoldKeyDown);
                el.addEventListener("input", tiempoHoldInput);
                el.addEventListener("paste", tiempoHoldPaste);
            });
        }

        // ================== CREAR ==================
        function abrirModalCrearHold() {
            // limpiar campos
            $("#crear_TiempoHold").val("");
            $("#crear_RangoFechas").val("");
            $("#crear_FechaInicio, #crear_FechaFinal").val("");
            $("#crear_EstadoHold").prop("checked", true);

            // next id
            $.get(URL_NEXT_HOLD, function (resp) {
                $("#crear_IdHold").val(resp.next_id || resp.next || "");
            });

            // selects
            initSelectHabitacion("#crear_IdHabitacion", "#modalCrearHold");
            initSelectReserva("#crear_IdReserva", "#modalCrearHold");

            // rango fechas (desde hoy)
            initRangoFechas(true);

            $("#modalCrearHold").modal("show");
        }

        function crearHold(btn) {
    // 1) Bloqueamos el botón de inmediato
    bloquearBoton(btn, "Guardando...");

    const idHold   = $("#crear_IdHold").val().trim();
    const idHab    = $("#crear_IdHabitacion").val();
    const idResStr = $("#crear_IdReserva").val();
    const tiempoStr= $("#crear_TiempoHold").val().trim();
    const fechaIni = $("#crear_FechaInicio").val();
    const fechaFin = $("#crear_FechaFinal").val();
    const estado   = $("#crear_EstadoHold").is(":checked");

    // ============ VALIDACIONES (si fallan, desbloqueamos y salimos) ============

    if (!idHold || !idHab || !idResStr) {
        desbloquearBoton(btn);
        return crudNotify("warning", "ID Hold, Habitación y Reserva son obligatorios.");
    }

    const idReserva = parseInt(idResStr, 10);
    if (Number.isNaN(idReserva)) {
        desbloquearBoton(btn);
        return crudNotify("warning", "La reserva seleccionada es inválida.");
    }

    if (!tiempoStr) {
        desbloquearBoton(btn);
        return crudNotify("warning", "Debe ingresar el tiempo del hold (en segundos).");
    }

    if (!fechaIni || !fechaFin) {
        desbloquearBoton(btn);
        return crudNotify("warning", "Debe seleccionar el rango completo de fechas.");
    }

    const tiempoNum = parseInt(tiempoStr, 10);
    if (isNaN(tiempoNum) || tiempoNum <= 0 || tiempoNum > MAX_TIEMPO_HOLD) {
        desbloquearBoton(btn);
        return crudNotify("warning",
            `El tiempo debe ser un número entre 1 y ${MAX_TIEMPO_HOLD}.`);
    }

    if (fechaFin < fechaIni) {
        desbloquearBoton(btn);
        return crudNotify("error", "La fecha final no puede ser menor que la inicial.");
    }

    // ============ SI TODO OK, ARMAMOS DATA ============

    const data = {
        IdHold:       idHold,
        IdHabitacion: idHab,
        IdReserva:    idReserva,
        TiempoHold:   tiempoStr,
        FechaInicio:  fechaIni || "",
        FechaFinal:   fechaFin || "",
        EstadoHold:   estado ? "true" : "false"
    };

    // ============ LLAMADA AL BACKEND ============

    crudCreate(URL_CREATE_HOLD, data, () => {
        $("#modalCrearHold").modal("hide");
        cargarHolds(currentPage);
        // solo aquí lo desbloqueamos al final
        desbloquearBoton(btn);
    });
}


        // ================== EDITAR ==================
        async function abrirModalEditarHold(id) {
            try {
                const resp = await $.get(URL_GET_HOLD(id));
                if (resp.status !== "ok") {
                    return crudNotify("error", resp.message || "No se pudo cargar el Hold.");
                }

                const h = resp.data;

                $("#editar_IdHold").val(h.IdHold);

                $("#editar_HabitacionTexto").val(
                    h.IdHabitacion + (h.NombreHabitacion ? " — " + h.NombreHabitacion : "")
                );
                $("#editar_IdHabitacion").val(h.IdHabitacion);

                $("#editar_ReservaTexto").val(
                    String(h.IdReserva) + (h.EstadoGeneralReserva ? " — " + h.EstadoGeneralReserva : "")
                );
                $("#editar_IdReserva").val(h.IdReserva);

                $("#editar_TiempoHold").val(h.TiempoHold || "");

                const fIni = h.FechaInicioHold ? h.FechaInicioHold.split("T")[0] : null;
                const fFin = h.FechaFinalHold ? h.FechaFinalHold.split("T")[0] : null;

                $("#editar_FechaInicio").val(fIni || "");
                $("#editar_FechaFinal").val(fFin || "");
                $("#editar_EstadoHold").prop("checked", !!h.EstadoHold);

                // rango fechas: min desde fecha inicio original
                initRangoFechas(false, fIni, fFin);

                $("#modalEditarHold").modal("show");
            } catch (e) {
                crudNotify("error", "Error al obtener datos para edición.");
            }
        }
function actualizarHold(btn) {
    bloquearBoton(btn, "Actualizando...");

    const id       = $("#editar_IdHold").val().trim();
    const idHab    = $("#editar_IdHabitacion").val();
    const idResStr = $("#editar_IdReserva").val();
    const tiempoStr= $("#editar_TiempoHold").val().trim();
    const fechaIni = $("#editar_FechaInicio").val();
    const fechaFin = $("#editar_FechaFinal").val();
    const estado   = $("#editar_EstadoHold").is(":checked");

    // ============ VALIDACIONES ============

    if (!idHab || !idResStr) {
        desbloquearBoton(btn);
        return crudNotify("warning", "Habitación y reserva son obligatorias.");
    }

    if (!tiempoStr) {
        desbloquearBoton(btn);
        return crudNotify("warning", "Debe ingresar el tiempo del hold.");
    }

    if (!fechaIni || !fechaFin) {
        desbloquearBoton(btn);
        return crudNotify("warning", "Debe seleccionar el rango completo de fechas.");
    }

    const idReserva = parseInt(idResStr, 10);
    if (isNaN(idReserva)) {
        desbloquearBoton(btn);
        return crudNotify("error", "Reserva inválida.");
    }

    const tiempoNum = parseInt(tiempoStr, 10);
    if (isNaN(tiempoNum) || tiempoNum <= 0 || tiempoNum > MAX_TIEMPO_HOLD) {
        desbloquearBoton(btn);
        return crudNotify("warning",
            `Tiempo inválido (1 - ${MAX_TIEMPO_HOLD}).`);
    }

    if (fechaFin < fechaIni) {
        desbloquearBoton(btn);
        return crudNotify("error", "La fecha final no puede ser menor que la inicial.");
    }

    // ============ DATA ============

    const data = {
        IdHabitacion: idHab,
        IdReserva:    idReserva,
        TiempoHold:   tiempoStr,
        FechaInicio:  fechaIni || "",
        FechaFinal:   fechaFin || "",
        EstadoHold:   estado ? "true" : "false"
    };

    // ============ LLAMADA BACKEND ============

    crudUpdate(URL_UPDATE_HOLD(id), data, () => {
        $("#modalEditarHold").modal("hide");
        cargarHolds(currentPage);
        desbloquearBoton(btn);
    });
}

        // ================== ELIMINAR ==================
        function eliminarHold(id) {
            crudConfirm("¿Está seguro de eliminar este Hold? Esto podría revertir la disponibilidad de una habitación.")
                .then(ok => {
                    if (!ok) return;
                    crudDelete(URL_DELETE_HOLD(id), () => cargarHolds(currentPage));
                });
        }

        // ================== INIT ==================
        $(document).ready(() => {

            // protección general: no permitir números negativos
            $("#modalCrearHold, #modalEditarHold")
                .on("input", "input[type=number]", function () {
                    const val = parseFloat(this.value);
                    if (!isNaN(val) && val < 0) this.value = "";
                });

            configurarTiempoHold();
            cargarHolds(1);
        });
    </script>
{% endblock %}