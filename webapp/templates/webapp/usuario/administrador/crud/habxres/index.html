{% extends "cabezal.html" %}
{% load static %}
{% block bloquear_footer %}
{% endblock %}
{% block css_archivos %}
    <link rel="stylesheet" href="{% static 'webapp/css/usuario/administrador/crud/crud_helper.css' %}">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0/dist/css/select2.min.css" rel="stylesheet"/>
    <style>
        .badge-estado {
            font-size: .85rem;
            padding: .25rem .6rem;
            border-radius: 12px;
        }

        .table-inactive {
            background-color: #e0e0e0 !important;
        }

        .select2-container {
            width: 100% !important;
        }
    </style>
{% endblock %}

{% block contenido_pagina %}

    <div id="crud-toast-container"></div>

    <div class="container mt-4">

        <!-- HEADER -->
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h2 class="fw-bold">Gestión Habitación por Reserva</h2>
            <button class="btn btn-primary" onclick="abrirModalCrearHabxRes()">
                <i class="bi bi-plus-lg"></i> Asignar Habitación
            </button>
        </div>

        <!-- TABLA -->
        <div class="table-responsive shadow-sm">
            <table class="table table-hover align-middle" id="tablaHabxRes">
                <thead class="table-dark">
                <tr>
                    <th>ID</th>
                    <th>Habitación</th>
                    <th>Reserva</th>
                    <th>Capacidad</th>
                    <th>Costo</th>
                    <th>Estado</th>
                    <th>Acciones</th>
                </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <!-- PAGINACIÓN -->
        <div class="d-flex justify-content-center align-items-center gap-3 mt-3">
            <button class="btn btn-secondary btn-sm" id="btnAnterior" disabled onclick="irAPaginaAnterior()">◀
                Anterior
            </button>
            <span id="infoPaginacion" class="fw-bold">Cargando…</span>
            <button class="btn btn-secondary btn-sm" id="btnSiguiente" disabled onclick="irAPaginaSiguiente()">Siguiente
                ▶
            </button>
        </div>

    </div>

    <!-- MODALES -->
    {% include "webapp/usuario/administrador/crud/habxres/modal_crear.html" %}
    {% include "webapp/usuario/administrador/crud/habxres/modal_editar.html" %}

{% endblock %}

{% block jvscript_archivos_defer %}

<script src="{% static 'webapp/js/usuario/administrador/crud/crud_helper.js' %}"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0/dist/js/select2.min.js"></script>

<script>
    /* ======================= CONSTANTES / URLs ======================= */
    const URL_LIST = "/admin/habxres/list/";
    const URL_CREATE = "/admin/habxres/create/";
    const URL_GET = id => `/admin/habxres/get/${id}/`;
    const URL_UPDATE = id => `/admin/habxres/update/${id}/`;
    const URL_DELETE = id => `/admin/habxres/delete/${id}/`;
    const URL_NEXT_ID = "/admin/habxres/next-id/";

    const MAX_DECIMAL = 999999.99;   // 6 enteros + 2 decimales
    const MAX_CAPACIDAD = 10;

    let currentPage = 1;
    let totalPages = 1;

    /* ======================= PAGINACIÓN ======================= */
    function actualizarPaginacion() {
        $("#btnAnterior").prop("disabled", currentPage <= 1);
        $("#btnSiguiente").prop("disabled", currentPage >= totalPages);
        $("#infoPaginacion").text(`Página ${currentPage} de ${totalPages}`);
    }

    function irAPaginaAnterior() {
        if (currentPage > 1) cargarHabxRes(currentPage - 1);
    }

    function irAPaginaSiguiente() {
        if (currentPage < totalPages) cargarHabxRes(currentPage + 1);
    }

    /* ================== VALIDACIÓN HABXRES ================== */
    function validarHabxResFront(data) {
        if (!data.IdReserva) {
            return "Debe seleccionar una reserva.";
        }

        if (!data.IdHabitacion) {
            return "Debe seleccionar una habitación.";
        }

        // Capacidad: entero 1..10 (opcional)
        if (data.CapacidadReservaHabxRes !== "" && data.CapacidadReservaHabxRes != null) {
            const cap = Number(data.CapacidadReservaHabxRes);
            if (!Number.isInteger(cap) || cap < 1 || cap > MAX_CAPACIDAD) {
                return `La capacidad debe ser un número entero entre 1 y ${MAX_CAPACIDAD}.`;
            }
        }

        // Costo obligatorio: 0..MAX_DECIMAL
        if (data.CostoCalculadoHabxRes === "" || data.CostoCalculadoHabxRes == null) {
            return "El costo es obligatorio.";
        }
        const costo = Number(data.CostoCalculadoHabxRes);
        if (Number.isNaN(costo) || costo < 0 || costo > MAX_DECIMAL) {
            return `El costo debe ser un número entre 0 y ${MAX_DECIMAL}.`;
        }

        // Descuento opcional: 0..MAX_DECIMAL
        if (data.DescuentoHabxRes !== "" && data.DescuentoHabxRes != null) {
            const des = Number(data.DescuentoHabxRes);
            if (Number.isNaN(des) || des < 0 || des > MAX_DECIMAL) {
                return `El descuento debe ser un número entre 0 y ${MAX_DECIMAL}.`;
            }
        }

        // Impuestos opcional: 0..MAX_DECIMAL
        if (data.ImpuestosHabxRes !== "" && data.ImpuestosHabxRes != null) {
            const imp = Number(data.ImpuestosHabxRes);
            if (Number.isNaN(imp) || imp < 0 || imp > MAX_DECIMAL) {
                return `Los impuestos deben ser un número entre 0 y ${MAX_DECIMAL}.`;
            }
        }

        return null; // sin errores
    }

    /* ======================= TABLA ======================= */
    function cargarHabxRes(page = 1) {
        currentPage = page;

        $.get(`${URL_LIST}?page=${page}`, function (resp) {
            const tbody = $("#tablaHabxRes tbody");
            tbody.empty();

            (resp.data || []).forEach(r => {
                const estado = r.EstadoHabxRes
                    ? `<span class="badge bg-success badge-estado">Activo</span>`
                    : `<span class="badge bg-secondary badge-estado">Inactivo</span>`;

                const filaClass = r.EstadoHabxRes ? "" : "table-secondary";

                const btnEliminar = r.EstadoHabxRes
                    ? `<button class="btn btn-danger btn-sm" onclick="eliminarHabxRes(${r.IdHabxRes})">Eliminar</button>`
                    : `<button class="btn btn-secondary btn-sm" disabled>Eliminado</button>`;

                tbody.append(`
                    <tr class="${filaClass}">
                        <td class="fw-bold">${r.IdHabxRes}</td>
                        <td>${r.IdHabitacion}</td>
                        <td>${r.IdReserva}</td>
                        <td>${r.CapacidadReservaHabxRes || "-"}</td>
                        <td>$${parseFloat(r.CostoCalculadoHabxRes || 0).toFixed(2)}</td>
                        <td>${estado}</td>
                        <td>
                            <button class="btn btn-warning btn-sm"
                                    onclick="abrirModalEditarHabxRes(${r.IdHabxRes})">Editar</button>
                            ${btnEliminar}
                        </td>
                    </tr>
                `);
            });

            currentPage  = resp.page;
            totalPages   = resp.total_pages;
            actualizarPaginacion();

        }).fail(() => crudNotify("error", "No se pudo cargar HabxRes"));
    }

    /* ======================= SELECT2 ======================= */
    function initSelectHabitacion(selector, reservaSelector) {
        $(selector).select2({
            dropdownParent: $(selector).closest(".modal"),
            placeholder: "Seleccione habitación...",
            width: "100%",
            ajax: {
                url: "/admin/habitaciones/search/",
                dataType: "json",
                delay: 300,
                data: params => ({
                    q: params.term,
                    reserva: $(reservaSelector).val()
                }),
                processResults: r => ({
                    results: (r.data || []).map(h => ({
                        id: h.IdHabitacion,
                        text: `${h.IdHabitacion} — ${h.NombreHabitacion || ""}`
                    }))
                })
            }
        });
    }

    function initSelectReserva(selector) {
        $(selector).select2({
            dropdownParent: $(selector).closest(".modal"),
            placeholder: "Buscar reserva...",
            minimumInputLength: 1,
            width: "100%",
            ajax: {
                url: "/admin/reservas/search/",
                dataType: "json",
                delay: 250,
                data: params => ({ q: params.term }),
                processResults: resp => ({
                    results: (resp.data || []).map(r => ({
                        id: r.IdReserva,
                        text: `Reserva #${r.IdReserva}`
                    }))
                })
            }
        });
    }

    /* ======================= CREAR ======================= */

    function abrirModalCrearHabxRes() {
        $("#crear_Capacidad,#crear_Costo,#crear_Descuento,#crear_Impuestos").val("");
        $("#crear_Estado").prop("checked", true);

        $.get(URL_NEXT_ID, function (resp) {
            if (resp.next) {
                $("#crear_IdHabxRes").val(resp.next);
            } else if (resp.next_id) {
                $("#crear_IdHabxRes").val(resp.next_id);
            }
        });

        initSelectReserva("#crear_IdReserva");
        initSelectHabitacion("#crear_IdHabitacion", "#crear_IdReserva");

        $("#crear_IdReserva").off("change").on("change", () => {
            $("#crear_IdHabitacion").val(null).trigger("change");
        });

        $("#modalCrearHabxRes").modal("show");
    }

    function esDecimalPositivo(v) {
        if (v == null) return false;
        v = String(v).replace(",", ".").trim();
        // hasta 6 enteros y 2 decimales
        if (!/^\d{1,6}(\.\d{1,2})?$/.test(v)) return false;
        const num = parseFloat(v);
        return !isNaN(num) && num >= 0 && num <= MAX_DECIMAL;
    }

    function esEnteroPositivo(v) {
        if (v == null) return false;
        v = String(v).trim();
        if (!/^\d+$/.test(v)) return false;
        const num = parseInt(v, 10);
        return Number.isInteger(num) && num > 0 && num <= MAX_CAPACIDAD;
    }

    function crearHabxRes() {
        let capacidad = $("#crear_Capacidad").val().trim();
        let costo     = $("#crear_Costo").val().trim();
        let desc      = $("#crear_Descuento").val().trim();
        let imp       = $("#crear_Impuestos").val().trim();

        if (capacidad !== "" && !esEnteroPositivo(capacidad)) {
            return crudNotify("error", `La capacidad debe ser un entero entre 1 y ${MAX_CAPACIDAD} (sin letras).`);
        }
        if (!esDecimalPositivo(costo)) {
            return crudNotify("error", `El costo debe ser un número entre 0 y ${MAX_DECIMAL}, con máximo 6 enteros y 2 decimales.`);
        }
        if (desc !== "" && !esDecimalPositivo(desc)) {
            return crudNotify("error", `El descuento debe ser un número entre 0 y ${MAX_DECIMAL}, con máximo 6 enteros y 2 decimales.`);
        }
        if (imp !== "" && !esDecimalPositivo(imp)) {
            return crudNotify("error", `Los impuestos deben ser un número entre 0 y ${MAX_DECIMAL}, con máximo 6 enteros y 2 decimales.`);
        }

        // Clamp al máximo y reescribir en los inputs
        let costoNum = Math.min(MAX_DECIMAL, parseFloat(costo.replace(",", ".")));
        $("#crear_Costo").val(costoNum.toFixed(2));
        costo = costoNum.toFixed(2);

        let descNum = null;
        if (desc !== "") {
            descNum = Math.min(MAX_DECIMAL, parseFloat(desc.replace(",", ".")));
            $("#crear_Descuento").val(descNum.toFixed(2));
            desc = descNum.toFixed(2);
        }

        let impNum = null;
        if (imp !== "") {
            impNum = Math.min(MAX_DECIMAL, parseFloat(imp.replace(",", ".")));
            $("#crear_Impuestos").val(impNum.toFixed(2));
            imp = impNum.toFixed(2);
        }

        const data = {
            IdHabxRes: $("#crear_IdHabxRes").val(),
            IdHabitacion: $("#crear_IdHabitacion").val(),
            IdReserva: $("#crear_IdReserva").val(),
            CapacidadReservaHabxRes: capacidad,
            CostoCalculadoHabxRes: costo,
            DescuentoHabxRes: desc,
            ImpuestosHabxRes: imp,
            EstadoHabxRes: $("#crear_Estado").is(":checked")
        };

        const error = validarHabxResFront(data);
        if (error) {
            crudNotify("error", error);
            return;
        }

        crudCreate(URL_CREATE, data, () => {
            $("#modalCrearHabxRes").modal("hide");
            cargarHabxRes(currentPage);
        });
    }

    /* ======================= EDITAR ======================= */

    async function abrirModalEditarHabxRes(id) {
        try {
            const resp = await $.get(URL_GET(id));

            if (resp.status !== "ok") {
                return crudNotify("error", resp.message || "No se pudo cargar el registro");
            }

            const r = resp.data;

            $("#editar_IdHabxRes").val(r.IdHabxRes);
            $("#editar_IdHabitacion").val(r.IdHabitacion);
            $("#editar_IdReserva").val(r.IdReserva);
            $("#editar_Capacidad").val(r.CapacidadReservaHabxRes);
            $("#editar_Costo").val(r.CostoCalculadoHabxRes);
            $("#editar_Descuento").val(r.DescuentoHabxRes);
            $("#editar_Impuestos").val(r.ImpuestosHabxRes);
            $("#editar_Estado").prop("checked", !!r.EstadoHabxRes);

            $("#modalEditarHabxRes").modal("show");

        } catch (e) {
            console.error(e);
            crudNotify("error", "Error al cargar el registro");
        }
    }

    function actualizarHabxRes() {
        let id   = $("#editar_IdHabxRes").val();
        let cap  = $("#editar_Capacidad").val().trim();
        let costo = $("#editar_Costo").val().trim();
        let desc  = $("#editar_Descuento").val().trim();
        let imp   = $("#editar_Impuestos").val().trim();

        if (cap !== "" && !esEnteroPositivo(cap)) {
            return crudNotify("error", `La capacidad debe ser un entero entre 1 y ${MAX_CAPACIDAD} (sin letras).`);
        }
        if (!esDecimalPositivo(costo)) {
            return crudNotify("error", `El costo debe ser un número entre 0 y ${MAX_DECIMAL}, con máximo 6 enteros y 2 decimales.`);
        }
        if (desc !== "" && !esDecimalPositivo(desc)) {
            return crudNotify("error", `El descuento debe ser un número entre 0 y ${MAX_DECIMAL}, con máximo 6 enteros y 2 decimales.`);
        }
        if (imp !== "" && !esDecimalPositivo(imp)) {
            return crudNotify("error", `Los impuestos deben ser un número entre 0 y ${MAX_DECIMAL}, con máximo 6 enteros y 2 decimales.`);
        }

        // Clamp y escribir en los inputs
        let costoNum = Math.min(MAX_DECIMAL, parseFloat(costo.replace(",", ".")));
        $("#editar_Costo").val(costoNum.toFixed(2));
        costo = costoNum.toFixed(2);

        let descNum = null;
        if (desc !== "") {
            descNum = Math.min(MAX_DECIMAL, parseFloat(desc.replace(",", ".")));
            $("#editar_Descuento").val(descNum.toFixed(2));
            desc = descNum.toFixed(2);
        }

        let impNum = null;
        if (imp !== "") {
            impNum = Math.min(MAX_DECIMAL, parseFloat(imp.replace(",", ".")));
            $("#editar_Impuestos").val(impNum.toFixed(2));
            imp = impNum.toFixed(2);
        }

        const data = {
            IdHabitacion: $("#editar_IdHabitacion").val(),
            IdReserva: $("#editar_IdReserva").val(),
            CapacidadReservaHabxRes: cap,
            CostoCalculadoHabxRes: costo,
            DescuentoHabxRes: desc,
            ImpuestosHabxRes: imp,
            EstadoHabxRes: $("#editar_Estado").is(":checked")
        };

        const error = validarHabxResFront(data);
        if (error) {
            crudNotify("error", error);
            return;
        }

        crudUpdate(URL_UPDATE(id), data, () => {
            $("#modalEditarHabxRes").modal("hide");
            cargarHabxRes(currentPage);
        });
    }

    /* ======================= ELIMINAR ======================= */
    function eliminarHabxRes(id) {
        crudConfirm("¿Desea desactivar esta relación?")
            .then(ok => {
                if (!ok) return;
                crudDelete(URL_DELETE(id), () => cargarHabxRes(currentPage));
            });
    }

    /* ======================= INIT ======================= */
    $(document).ready(function () {
        $("#modalCrearHabxRes, #modalEditarHabxRes")
            .on("input", "input[type=number]", function () {
                const v = parseFloat(this.value);
                if (!isNaN(v) && v < 0) this.value = "";
            });

        cargarHabxRes(1);
    });
</script>

<script>
    /* ======================= HELPERS NUMÉRICOS ======================= */
    function limpiarDecimal(v) {
        if (v == null) return "";
        v = String(v).replace(",", ".").trim();
        v = v.replace(/[^0-9.]/g, "");
        const partes = v.split(".");
        if (partes.length > 2) {
            v = partes[0] + "." + partes[1];
        }
        return v;
    }

    function limpiarEntero(v) {
        if (v == null) return "";
        v = String(v).trim();
        return v.replace(/[^0-9]/g, "");
    }

    function decimalKeyDown(e) {
        const controlKeys = ["Backspace","Tab","ArrowLeft","ArrowRight","Delete","Home","End"];
        if (controlKeys.includes(e.key)) return;
        if (e.ctrlKey || e.metaKey) return;

        if (e.key === "." || e.key === ",") {
            if (this.value.includes(".") || this.value.includes(",")) {
                e.preventDefault();
            }
            return;
        }

        if (!/^[0-9]$/.test(e.key)) {
            e.preventDefault();
        }
    }

    function decimalInput(e) {
        let v = limpiarDecimal(this.value);
        let partes = v.split(".");

        // máximo 6 enteros
        if (partes[0].length > 6) {
            partes[0] = partes[0].slice(0, 6);
        }
        // máximo 2 decimales
        if (partes.length === 2 && partes[1].length > 2) {
            partes[1] = partes[1].slice(0, 2);
        }
        v = partes.length === 2 ? partes[0] + "." + partes[1] : partes[0];

        if (this.value !== v) {
            this.value = v;
        }
    }

    function decimalPaste(e) {
        e.preventDefault();
        let txt = (e.clipboardData || window.clipboardData).getData("text");
        this.value = txt;
        decimalInput.call(this);
    }

    function enteroKeyDown(e) {
        const controlKeys = ["Backspace","Tab","ArrowLeft","ArrowRight","Delete","Home","End"];
        if (controlKeys.includes(e.key)) return;
        if (e.ctrlKey || e.metaKey) return;
        if (!/^[0-9]$/.test(e.key)) {
            e.preventDefault();
        }
    }

    function enteroInput(e) {
        let v = limpiarEntero(this.value);
        if (v.length > 2) v = v.slice(0, 2); // para 1..10
        this.value = v;
    }

    function enteroPaste(e) {
        e.preventDefault();
        let txt = (e.clipboardData || window.clipboardData).getData("text");
        this.value = txt;
        enteroInput.call(this);
    }

    function configurarNumericosHabxRes() {
        const decimalIds = [
            "crear_Costo","crear_Descuento","crear_Impuestos",
            "editar_Costo","editar_Descuento","editar_Impuestos"
        ];
        const enteroIds = ["crear_Capacidad","editar_Capacidad"];

        decimalIds.forEach(id => {
            const el = document.getElementById(id);
            if (!el) return;
            el.addEventListener("keydown", decimalKeyDown);
            el.addEventListener("input", decimalInput);
            el.addEventListener("paste", decimalPaste);
        });

        enteroIds.forEach(id => {
            const el = document.getElementById(id);
            if (!el) return;
            el.addEventListener("keydown", enteroKeyDown);
            el.addEventListener("input", enteroInput);
            el.addEventListener("paste", enteroPaste);
        });
    }

    document.addEventListener("DOMContentLoaded", configurarNumericosHabxRes);
</script>

{% endblock %}
