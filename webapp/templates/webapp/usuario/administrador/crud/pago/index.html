{% extends "cabezal.html" %}
{% load static %}
{% block bloquear_footer %}
{% endblock %}
{% block css_archivos %}
    <link rel="stylesheet" href="{% static 'webapp/css/usuario/administrador/crud/crud_helper.css' %}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css">
    <style>
        .badge-estado {
            font-size: .85rem;
            padding: .25rem .6rem;
            border-radius: 15px;
        }
    </style>
    <style>
        /* FILA INACTIVA (PAGOS / RESERVAS / ETC) */
        .table-inactive {
            background-color: #e5e5e5 !important;
        }

        .table-inactive td {
            background-color: #e5e5e5 !important;
        }

        /* ACENTUAR TEXTO OPCIONAL */
        .table-inactive td {
            color: #6c757d;
        }

        /* Hover NO cambia color (sigue gris) */
        .table-hover tbody tr.table-inactive:hover td {
            background-color: #dcdcdc !important;
        }

    </style>
{% endblock %}

{% block contenido_pagina %}

    <div id="crud-toast-container"></div>

    <div class="container mt-4">

        <div class="d-flex justify-content-between align-items-center mb-3">
            <h2 class="fw-bold">Gestión de Pagos</h2>
            <button class="btn btn-primary" onclick="abrirModalCrearPago()">
                <i class="bi bi-plus-lg"></i> Registrar Pago
            </button>
        </div>


        <!-- TABLA -->
        <div class="table-responsive shadow-sm">
            <table class="table table-hover align-middle" id="tablaPagos">
                <thead class="table-dark">
                <tr>
                    <th>ID Pago</th>
                    <th>Factura</th>
                    <th>Monto</th>
                    <th>Método Pago</th>
                    <th>Usuario Interno</th>
                    <th>Cuenta Origen</th>
                    <th>Cuenta Destino</th>
                    <th>Estado</th>
                    <th>Acciones</th>
                </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

    </div>

    {% include "webapp/usuario/administrador/crud/pago/modal_crear.html" %}
    {% include "webapp/usuario/administrador/crud/pago/modal_editar.html" %}
    <!-- PAGINACIÓN (igual estilo que otros CRUDs) -->
    <div class="d-flex justify-content-center align-items-center gap-3 mt-3">
        <button class="btn btn-secondary btn-sm" id="btnAnterior" onclick="irAPaginaAnterior()" disabled>
            ◀ Anterior
        </button>
        <span id="infoPaginacion" class="fw-bold">Cargando...</span>
        <button class="btn btn-secondary btn-sm" id="btnSiguiente" onclick="irAPaginaSiguiente()" disabled>
            Siguiente ▶
        </button>
    </div>
{% endblock %}

{% block jvscript_archivos_defer %}
    <script src="{% static 'webapp/js/usuario/administrador/crud/crud_helper.js' %}"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <script>
        const URL_LIST_PAGO = "/admin/pago/list/";
        const URL_CREATE_PAGO = "/admin/pago/create/";
        const URL_GET_PAGO = id => `/admin/pago/get/${id}/`;
        const URL_UPDATE_PAGO = id => `/admin/pago/update/${id}/`;
        const URL_DELETE_PAGO = id => `/admin/pago/delete/${id}/`;
        const URL_NEXT_PAGO = "/admin/pago/next-id/";
        const URL_SEARCH_METODO = "/admin/metodo-pago/search/";
        const URL_SEARCH_FACTURA = "/admin/factura/search/";
        const URL_SEARCH_USUARIO = "/admin/usuario-interno/search/";
        const URL_CUENTAS = "/cuentas-xml/";
        const TABLA_SELECTOR_PAGO = "#tablaPagos";
        const MAX_MONTO = 999999.99;
        let currentPage = 1;
        let totalPages = 1;
        let cuentasCache = null;

        async function obtenerCuentas() {
            if (cuentasCache) return cuentasCache;

            const resp = await fetch(URL_CUENTAS);
            const data = await resp.json();

            if (!data.cuentas || !Array.isArray(data.cuentas)) {
                throw "Respuesta inválida del servicio de cuentas";
            }

            cuentasCache = data.cuentas.map(String);
            return cuentasCache;
        }


        async function validarCuentaExiste(idCuenta) {
            const cuentas = await obtenerCuentas();
            return cuentas.includes(String(idCuenta));
        }


        // ================== HELPERS GENERALES ==================
        function formatearMonto(valor) {
            const n = parseFloat(valor);
            if (isNaN(n)) return "0.00";
            return n.toFixed(2);
        }

        function formatearCuenta(valor) {
            if (!valor) return "N/A";
            return valor;
        }

        function limpiarDecimalMonto(v) {
            if (v == null) return "";
            v = String(v).replace(",", ".").trim();
            v = v.replace(/[^0-9.]/g, "");      // solo dígitos y punto
            return v;
        }

        function normalizarMonto(v) {
            v = limpiarDecimalMonto(v);
            if (!v) return "";

            // hasta 6 enteros y 2 decimales
            const regex = /^\d{1,6}(\.\d{1,2})?$/;
            if (!regex.test(v)) {
                // si no cumple el formato, recortamos
                let [ent, dec = ""] = v.split(".");
                ent = ent.slice(0, 6);
                dec = dec.slice(0, 2);
                v = ent + (dec ? "." + dec : "");
            }

            let num = parseFloat(v || "0");
            if (isNaN(num) || num <= 0) return "";

            if (num > MAX_MONTO) num = MAX_MONTO;
            return num.toFixed(2);   // string “999999.99”
        }

        // ----------- helpers para monto (input) -----------
        function limpiarDecimal(v) {
            if (v == null) return "";
            v = String(v).replace(",", ".").trim();
            // sólo dígitos y punto
            v = v.replace(/[^0-9.]/g, "");
            return v;
        }

        function esMontoValido(v) {
            if (v == null) return false;
            v = String(v).replace(",", ".").trim();
            // hasta 6 enteros y 2 decimales
            if (!/^\d{1,6}(\.\d{1,2})?$/.test(v)) return false;
            const num = parseFloat(v);
            return !isNaN(num) && num > 0 && num <= MAX_MONTO;
        }

        function montoKeyDown(e) {
            const controlKeys = [
                "Backspace", "Tab", "ArrowLeft", "ArrowRight",
                "Delete", "Home", "End"
            ];
            if (controlKeys.includes(e.key)) return;
            if (e.ctrlKey || e.metaKey) return; // Ctrl+C, etc.

            // permitir un solo punto o coma
            if (e.key === "." || e.key === ",") {
                if (this.value.includes(".") || this.value.includes(",")) {
                    e.preventDefault();
                }
                return;
            }

            // sólo dígitos
            if (!/^[0-9]$/.test(e.key)) {
                e.preventDefault();
            }
        }

        function montoInput(e) {
            let v = limpiarDecimal(this.value);
            let parts = v.split(".");

            // máximo 6 dígitos enteros
            if (parts[0].length > 6) {
                parts[0] = parts[0].slice(0, 6);
            }

            if (parts.length === 2) {
                // máximo 2 decimales
                if (parts[1].length > 2) {
                    parts[1] = parts[1].slice(0, 2);
                }
                v = parts[0] + "." + parts[1];
            } else {
                v = parts[0];
            }

            this.value = v;
        }

        function montoBlur(e) {
            // al salir del campo, normalizamos y aplicamos límite MAX_MONTO
            let v = limpiarDecimal(this.value);
            if (!v) {
                this.value = "";
                return;
            }
            let num = parseFloat(v);
            if (isNaN(num) || num <= 0) {
                this.value = "";
                return;
            }
            if (num > MAX_MONTO) num = MAX_MONTO;
            this.value = num.toFixed(2);
        }

        function montoPaste(e) {
            e.preventDefault();
            let txt = (e.clipboardData || window.clipboardData).getData("text");
            let v = limpiarDecimal(txt);
            let temp = document.createElement("input");
            temp.value = v;
            montoInput.call(temp);         // reutilizamos lógica de recorte
            let final = temp.value;
            let num = parseFloat(final || "0");
            if (!isNaN(num) && num > MAX_MONTO) num = MAX_MONTO;
            this.value = num ? num.toFixed(2) : "";
        }

        function configurarMontoTotal() {
            const ids = ["crear_MontoTotal", "editar_MontoTotal"];
            ids.forEach(id => {
                const el = document.getElementById(id);
                if (!el) return;
                el.addEventListener("keydown", montoKeyDown);
                el.addEventListener("input", montoInput);
                el.addEventListener("blur", montoBlur);
                el.addEventListener("paste", montoPaste);
            });
        }

        // ================== PAGINACIÓN ==================
        function actualizarControlesPaginacion() {
            $("#btnAnterior").prop("disabled", currentPage <= 1);
            $("#btnSiguiente").prop("disabled", currentPage >= totalPages);
            $("#infoPaginacion").text(`Página ${currentPage} de ${totalPages}`);
        }

        function irAPaginaAnterior() {
            if (currentPage > 1) cargarPagos(currentPage - 1);
        }

        function irAPaginaSiguiente() {
            if (currentPage < totalPages) cargarPagos(currentPage + 1);
        }

        // ================== CARGAR TABLA ==================
        function cargarPagos(page = 1) {
            const url_with_page = `${URL_LIST_PAGO}?page=${page}`;

            $.ajax({
                url: url_with_page,
                method: "GET",
                success: function (resp) {
                    const tbody = document.querySelector(TABLA_SELECTOR_PAGO + " tbody");
                    if (!tbody) {
                        console.error("No se encontró tbody para tabla de pagos");
                        return;
                    }
                    tbody.innerHTML = "";

                    (resp.data || []).forEach(p => {
                        const estadoBadge = p.EstadoPago
                            ? `<span class="badge bg-success badge-estado">Completo</span>`
                            : `<span class="badge bg-danger badge-estado">Pendiente/Fallido</span>`;

                        const btnEliminar = p.EstadoPago
                            ? `<button class="btn btn-danger btn-sm" onclick="eliminarPago(${p.IdPago})">Eliminar</button>`
                            : `<button class="btn btn-secondary btn-sm" disabled>Eliminado</button>`;

                        const rowHtml = `
                            <tr class="${p.EstadoPago ? "" : "table-secondary"}">
                                <td>${p.IdPago}</td>
                                <td>${p.IdFactura}</td>
                                <td>${formatearMonto(p.MontoTotalPago)}</td>
                                <td>${p.IdMetodoPago}</td>
                                <td>${p.IdUnicoUsuario}</td>
                                <td>${formatearCuenta(p.CuentaOrigenPago)}</td>
                                <td>${formatearCuenta(p.CuentaDestinoPago)}</td>
                                <td>${estadoBadge}</td>
                                <td>
                                    <button class="btn btn-warning btn-sm"
                                            onclick="abrirModalEditarPago(${p.IdPago})">
                                        Editar
                                    </button>
                                    ${btnEliminar}
                                </td>
                            </tr>`;
                        tbody.insertAdjacentHTML("beforeend", rowHtml);
                    });

                    currentPage = resp.page || 1;
                    totalPages = resp.total_pages || 1;
                    actualizarControlesPaginacion();
                },
                error: function (xhr) {
                    crudNotify("error",
                        xhr.responseJSON?.message || "No se pudo cargar la información de Pagos."
                    );
                }
            });
        }

        // ================== SELECT2 HELPERS ==================
        function initSelectMetodoPago(selector, parentSelector) {
            const $sel = $(selector);
            if ($sel.data("select2")) $sel.select2("destroy");
            $sel.val("");

            $sel.select2({
                placeholder: "Buscar método de pago...",
                allowClear: true,
                width: "100%",
                dropdownParent: $(parentSelector),
                minimumInputLength: 0,
                ajax: {
                    url: URL_SEARCH_METODO,
                    dataType: "json",
                    delay: 250,
                    data: params => ({q: params.term || ""}),
                    processResults: resp => ({
                        results: (resp.data || []).map(m => {
                            const id = m.IdMetodoPago ?? m.idMetodoPago;
                            const nombre = m.NombreMetodoPago ?? m.nombreMetodoPago ?? "";
                            return {id: id, text: `${id} — ${nombre}`};
                        })
                    })
                }
            });
        }

        function initSelectUsuarioInterno(selector, parentSelector) {
            const $sel = $(selector);
            if ($sel.data("select2")) $sel.select2("destroy");
            $sel.val("");

            $sel.select2({
                placeholder: "Buscar usuario interno...",
                allowClear: true,
                width: "100%",
                dropdownParent: $(parentSelector),
                minimumInputLength: 0,
                ajax: {
                    url: URL_SEARCH_USUARIO,
                    dataType: "json",
                    delay: 250,
                    data: params => ({q: params.term || ""}),
                    processResults: resp => ({
                        results: (resp.data || []).map(u => ({
                            id: u.Id,
                            text: `${u.Id} — ${u.Nombre} ${u.Apellido} (${u.Correo})`
                        }))
                    })
                }
            });
        }

        function initSelectFactura(selector, parentSelector) {
            const $sel = $(selector);
            if ($sel.data("select2")) $sel.select2("destroy");
            $sel.val("");

            $sel.select2({
                placeholder: "Buscar factura...",
                allowClear: true,
                width: "100%",
                dropdownParent: $(parentSelector),
                minimumInputLength: 0,
                ajax: {
                    url: URL_SEARCH_FACTURA,
                    dataType: "json",
                    delay: 250,
                    data: params => ({q: params.term}),
                    processResults: resp => {
                        const items = resp.data || [];
                        return {
                            results: items.map(f => {
                                const idFactura = f.IdFactura ?? f.idFactura;
                                const idReserva = f.IdReserva ?? f.idReserva;
                                const totalCalc = f.TotalCalculado ?? f.totalCalculado ?? 0;
                                return {
                                    id: idFactura,
                                    text: `IdFactura: ${idFactura} — Reserva: ${idReserva} — Total: ${parseFloat(totalCalc).toFixed(2)}`
                                };
                            })
                        };
                    }
                }
            });
        }

        // ================== CREAR ==================
        function abrirModalCrearPago() {
            // id
            $("#crear_IdPago").val("");
            $.get(URL_NEXT_PAGO, function (resp) {
                const nextId = resp.next || "";
                $("#crear_IdPago").val(nextId);
            }).fail(() => {
                $("#crear_IdPago").val("");
            });

            // limpiar campos
            $("#crear_MontoTotal").val("");
            $("#crear_CuentaOrigen").val("");
            $("#crear_CuentaDestino").val("");
            $("#crear_EstadoPago").prop("checked", true);

            // selects
            initSelectMetodoPago("#crear_IdMetodoPago", "#modalCrearPago");
            initSelectFactura("#crear_IdFactura", "#modalCrearPago");
            initSelectUsuarioInterno("#crear_IdUnicoUsuario", "#modalCrearPago");

            $("#modalCrearPago").modal("show");
        }

async function crearPago(btn) {
    bloquearBoton(btn, "Guardando...");

    const idPago = $("#crear_IdPago").val().trim();
    const idMetodoPago = $("#crear_IdMetodoPago").val();
    const idFactura = $("#crear_IdFactura").val();
    const idUsuarioInt = $("#crear_IdUnicoUsuario").val();
    const montoStr = $("#crear_MontoTotal").val();
    const cuentaOrigen = $("#crear_CuentaOrigen").val().trim();
    const cuentaDestino = $("#crear_CuentaDestino").val().trim();

    try {

        // VALIDACIONES
        if (!cuentaOrigen) throw "La cuenta de origen es obligatoria.";
        if (!cuentaDestino) throw "La cuenta de destino es obligatoria.";

        if (!idPago || !idMetodoPago || !idFactura || !idUsuarioInt || !montoStr) {
            throw "ID Pago, Método, Factura, Usuario y Monto son obligatorios.";
        }

        if (cuentaOrigen === cuentaDestino) {
            throw "La cuenta ORIGEN y DESTINO no pueden ser iguales.";
        }

        const montoNormalizado = normalizarMonto(montoStr);
        if (!montoNormalizado) {
            throw `El monto debe ser mayor a 0 y menor o igual a ${MAX_MONTO}.`;
        }

        // VALIDAR CUENTAS EXTERNAS
        const existeOrigen = await validarCuentaExiste(cuentaOrigen);
        const existeDestino = await validarCuentaExiste(cuentaDestino);

        if (!existeOrigen) throw `La cuenta ORIGEN no existe: ${cuentaOrigen}`;
        if (!existeDestino) throw `La cuenta DESTINO no existe: ${cuentaDestino}`;

        const payload = {
            IdPago: parseInt(idPago),
            IdMetodoPago: parseInt(idMetodoPago),
            IdFactura: parseInt(idFactura),
            IdUnicoUsuario: parseInt(idUsuarioInt),
            MontoTotal: montoNormalizado,
            CuentaOrigen: cuentaOrigen,
            CuentaDestino: cuentaDestino,
            IdUnicoUsuarioExterno: null,
            EstadoPago: $("#crear_EstadoPago").is(":checked")
        };

        $.ajax({
            url: URL_CREATE_PAGO,
            method: "POST",
            data: payload
        })
        .done(resp => {
            crudNotify("success", resp.message || "Pago creado correctamente.");
            $("#modalCrearPago").modal("hide");
            cargarPagos(currentPage);
        })
        .fail(xhr => {
            crudNotify("error", xhr.responseJSON?.message || "Error al crear el pago.");
        })
        .always(() => {
            desbloquearBoton(btn);
        });

    } catch (err) {
        crudNotify("error", err);
        desbloquearBoton(btn);
    }
}


        // ================== EDITAR ==================
        function abrirModalEditarPago(id) {
            $.get(URL_GET_PAGO(id), function (resp) {
                if (resp.status !== "ok") {
                    return crudNotify("error", resp.message || "No se pudo cargar el pago.");
                }

                const p = resp.data;

                $("#editar_IdPago").val(p.IdPago);
                $("#editar_MontoTotal").val(p.MontoTotalPago);
                $("#editar_CuentaOrigen").val(p.CuentaOrigenPago);
                $("#editar_CuentaDestino").val(p.CuentaDestinoPago);
                $("#editar_EstadoPago").prop("checked", !!p.EstadoPago);

                // selects
                initSelectMetodoPago("#editar_IdMetodoPago", "#modalEditarPago");
                initSelectFactura("#editar_IdFactura", "#modalEditarPago");
                initSelectUsuarioInterno("#editar_IdUnicoUsuario", "#modalEditarPago");

                // preselección
                if (p.IdMetodoPago) {
                    const optM = new Option(`${p.IdMetodoPago}`, p.IdMetodoPago, true, true);
                    $("#editar_IdMetodoPago").append(optM).trigger("change");
                }
                if (p.IdFactura) {
                    const optF = new Option(`${p.IdFactura}`, p.IdFactura, true, true);
                    $("#editar_IdFactura").append(optF).trigger("change");
                }
                if (p.IdUnicoUsuario) {
                    const optU = new Option(`${p.IdUnicoUsuario}`, p.IdUnicoUsuario, true, true);
                    $("#editar_IdUnicoUsuario").append(optU).trigger("change");
                }

                $("#modalEditarPago").modal("show");
            }).fail(xhr => {
                crudNotify("error", xhr.responseJSON?.message || "Error al obtener datos para edición.");
            });
        }


        async function actualizarPago(btn) {
    bloquearBoton(btn, "Actualizando...");

    const idPago = $("#editar_IdPago").val();
    const idMetodoPago = $("#editar_IdMetodoPago").val();
    const idFactura = $("#editar_IdFactura").val();
    const idUsuarioInt = $("#editar_IdUnicoUsuario").val();
    const montoStr = $("#editar_MontoTotal").val();
    const cuentaOrigen = $("#editar_CuentaOrigen").val().trim();
    const cuentaDestino = $("#editar_CuentaDestino").val().trim();

    try {

        if (!cuentaOrigen) throw "La cuenta ORIGEN es obligatoria.";
        if (!cuentaDestino) throw "La cuenta DESTINO es obligatoria.";

        if (cuentaOrigen === cuentaDestino) {
            throw "Las cuentas no pueden ser iguales.";
        }

        const montoNormalizado = normalizarMonto(montoStr);
        if (!montoNormalizado) {
            throw `Monto inválido (máx ${MAX_MONTO}).`;
        }

        const existeOrigen = await validarCuentaExiste(cuentaOrigen);
        const existeDestino = await validarCuentaExiste(cuentaDestino);

        if (!existeOrigen) throw `Cuenta ORIGEN inválida: ${cuentaOrigen}`;
        if (!existeDestino) throw `Cuenta DESTINO inválida: ${cuentaDestino}`;

        const payload = {
            IdMetodoPago: parseInt(idMetodoPago),
            IdFactura: parseInt(idFactura),
            IdUnicoUsuario: parseInt(idUsuarioInt),
            MontoTotal: montoNormalizado,
            CuentaOrigen: cuentaOrigen,
            CuentaDestino: cuentaDestino,
            EstadoPago: $("#editar_EstadoPago").is(":checked")
        };

        $.ajax({
            url: URL_UPDATE_PAGO(idPago),
            method: "POST",
            data: payload
        })
        .done(resp => {
            crudNotify("success", resp.message || "Pago actualizado.");
            $("#modalEditarPago").modal("hide");
            cargarPagos(currentPage);
        })
        .fail(xhr => {
            crudNotify("error", xhr.responseJSON?.message || "Error al actualizar.");
        })
        .always(() => {
            desbloquearBoton(btn);
        });

    } catch (err) {
        crudNotify("error", err);
        desbloquearBoton(btn);
    }
}

        // ================== ELIMINAR ==================
        function eliminarPago(id) {
            crudConfirm("¿Está seguro de eliminar este Pago? Esto lo marcará como inactivo.")
                .then(ok => {
                    if (!ok) return;
                    crudDelete(URL_DELETE_PAGO(id), () => cargarPagos(currentPage));
                });
        }

        // ================== INIT ==================
        $(document).ready(function () {
            configurarMontoTotal();
            cargarPagos(1);
            $("#btnAnterior").on("click", irAPaginaAnterior);
            $("#btnSiguiente").on("click", irAPaginaSiguiente);
        });
    </script>
{% endblock %}
