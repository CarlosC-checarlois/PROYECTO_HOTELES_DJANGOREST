{% extends "cabezal.html" %}
{% load static %}

{% block bloquear_footer %}{% endblock %}

{% block css_archivos %}
<link rel="stylesheet" href="{% static 'webapp/css/usuario/administrador/crud/crud_helper.css' %}">
<style>
    .badge-estado{
        font-size:.85rem;
        padding:.25rem .6rem;
        border-radius:15px;
    }
    .readonly-input{
        background-color:#f0f0f0 !important;
        color:#6c757d !important;
        cursor:not-allowed !important;
    }
</style>
{% endblock %}

{% block contenido_pagina %}

<div id="crud-toast-container"></div>

<div class="container mt-4">

    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 class="fw-bold">Gestión de Usuarios Internos</h2>
        <button class="btn btn-primary" onclick="abrirModalCrearUsuarioInterno()">
            <i class="bi bi-plus-lg"></i> Agregar Usuario
        </button>
    </div>

    <div class="table-responsive shadow-sm">
        <table class="table table-hover align-middle" id="tablaUsuariosInternos">
            <thead class="table-dark">
                <tr>
                    <th>ID</th>
                    <th>Nombre completo</th>
                    <th>Correo</th>
                    <th>Documento</th>
                    <th>Rol</th>
                    <th>Estado</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <div class="d-flex justify-content-center align-items-center gap-3 mt-3">
        <button class="btn btn-secondary btn-sm" id="btnAnterior" onclick="irAPaginaAnterior()" disabled>
            ◀ Anterior
        </button>
        <span id="infoPaginacion" class="fw-bold">Página 1 de 1</span>
        <button class="btn btn-secondary btn-sm" id="btnSiguiente" onclick="irAPaginaSiguiente()" disabled>
            Siguiente ▶
        </button>
    </div>

</div>

{% include "webapp/usuario/administrador/crud/usuarios_internos/modal_crear.html" %}
{% include "webapp/usuario/administrador/crud/usuarios_internos/modal_editar.html" %}

{% endblock %}

{% block jvscript_archivos_defer %}
<script src="{% static 'webapp/js/usuario/administrador/crud/crud_helper.js' %}"></script>

<script>
// ================== URLs backend Django ==================
const URL_LIST   = "/admin/usuarios-internos/list/";
const URL_CREATE = "/admin/usuarios-internos/create/";
const URL_GET    = id => `/admin/usuarios-internos/get/${id}/`;
const URL_UPDATE = id => `/admin/usuarios-internos/update/${id}/`;
const URL_DELETE = id => `/admin/usuarios-internos/delete/${id}/`;
const URL_NEXTID = "/admin/usuario-interno/next-id/";

// ================== ROL API REAL ==================
const URL_ROLES_REST = "https://gereca-dgd0hedaedb2dge4.canadacentral-01.azurewebsites.net/api/gestion/rol";

let currentPage = 1;
let totalPages  = 1;

// ================== UTIL ==================
function badgeEstado(activo){
    return activo
        ? '<span class="badge bg-success badge-estado">Activo</span>'
        : '<span class="badge bg-secondary badge-estado">Inactivo</span>';
}

// ================== PAGINACIÓN ==================
function actualizarControlesPaginacion(){
    $("#btnAnterior").prop("disabled", currentPage <= 1);
    $("#btnSiguiente").prop("disabled", currentPage >= totalPages);
    $("#infoPaginacion").text(`Página ${currentPage} de ${totalPages}`);
}
function irAPaginaAnterior(){ if(currentPage>1) cargarUsuarios(currentPage-1); }
function irAPaginaSiguiente(){ if(currentPage<totalPages) cargarUsuarios(currentPage+1); }

// ================== TABLA ==================
function cargarUsuarios(page=1){
    $.get(`${URL_LIST}?page=${page}`, function(resp){

        if(resp.status !== "ok"){
            crudNotify("error", resp.message || "No se pudo cargar usuarios.");
            return;
        }

        const tbody = $("#tablaUsuariosInternos tbody");
        tbody.empty();

        (resp.data || []).forEach(u => {

            const nombre = `${u.Nombre || ""} ${u.Apellido || ""}`;
            const doc = `${u.TipoDocumento || ""} ${u.Documento || ""}`.trim();
            const estado = !!u.Estado;

            const row = `
                <tr class="${estado ? "" : "table-secondary"}">
                    <td>${u.Id}</td>
                    <td>${nombre}</td>
                    <td>${u.Correo || ""}</td>
                    <td>${doc}</td>
                    <td>${u.IdRol || ""}</td>
                    <td>${badgeEstado(estado)}</td>
                    <td>
                        <button class="btn btn-warning btn-sm"
                                onclick="abrirModalEditarUsuarioInterno(${u.Id})">Editar</button>
                        <button class="btn btn-danger btn-sm"
                                onclick="eliminarUsuarioInterno(${u.Id})">Eliminar</button>
                    </td>
                </tr>
            `;
            tbody.append(row);
        });

        currentPage = resp.page || 1;
        totalPages = resp.total_pages || 1;
        actualizarControlesPaginacion();
    });
}

// ================== ROLES ==================
function cargarRoles(selectId, selected=null){

    const combo = $(selectId);
    combo.empty();
    combo.append("<option value=''>Seleccione rol...</option>");

    $.get(URL_ROLES_REST, function(roles){

        (roles || []).forEach(r => {

            if(!r.EstadoRol) return;   // SOLO ACTIVOS ✅

            const sel = (selected == r.IdRol) ? "selected" : "";

            combo.append(`
                <option value="${r.IdRol}" ${sel}>
                    ${r.NombreRol}
                </option>
            `);
        });
    }).fail(() => {
        crudNotify("error","No se pudieron cargar los roles.");
    });
}

// ================== CREAR ==================
function abrirModalCrearUsuarioInterno(){

    $.get(URL_NEXTID, resp => {
        $("#crear_IdUsuarioInterno").val(resp.next_id || "");
    });

    cargarRoles("#crear_idRol");

    $("#modalCrearUsuario").modal("show");
}

function crearUsuarioInterno(){

    const data = {
        rol: $("#crear_idRol").val(),
        nombre: $("#crear_nombre").val(),
        apellido: $("#crear_apellido").val(),
        correo: $("#crear_correo").val(),
        clave: $("#crear_clave").val(),
        fecha_nac: $("#crear_fechaNac").val(),
        tipo_doc: $("#crear_tipoDoc").val(),
        documento: $("#crear_documento").val(),
        estado: $("#crear_estado").is(":checked") ? "true" : "false"
    };

    crudCreate(URL_CREATE, data, () => {
        $("#modalCrearUsuario").modal("hide");
        cargarUsuarios();
    });
}

// ================== EDITAR ==================
function abrirModalEditarUsuarioInterno(id){

    $.get(URL_GET(id), function(resp){

        if(resp.status !== "ok"){
            crudNotify("error", resp.message);
            return;
        }

        const u = resp.data;

        $("#editar_IdUsuarioInterno").val(u.Id);
        $("#editar_nombre").val(u.Nombre);
        $("#editar_apellido").val(u.Apellido);
        $("#editar_correo").val(u.Correo);
        $("#editar_fechaNac").val(u.FechaNacimiento?.substring(0,10));
        $("#editar_tipoDoc").val(u.TipoDocumento);
        $("#editar_documento").val(u.Documento);
        $("#editar_estado").prop("checked", !!u.Estado);

        cargarRoles("#editar_idRol", u.IdRol);

        $("#modalEditarUsuario").modal("show");
    });
}

// ================== UPDATE ==================
function actualizarUsuarioInterno(){

    const id = $("#editar_IdUsuarioInterno").val();

    const data = {
        rol: $("#editar_idRol").val(),
        nombre: $("#editar_nombre").val(),
        apellido: $("#editar_apellido").val(),
        correo: $("#editar_correo").val(),
        clave: $("#editar_clave").val(),
        fecha_nac: $("#editar_fechaNac").val(),
        tipo_doc: $("#editar_tipoDoc").val(),
        documento: $("#editar_documento").val(),
        estado: $("#editar_estado").is(":checked") ? "true" : "false"
    };

    crudUpdate(URL_UPDATE(id), data, () => {
        $("#modalEditarUsuario").modal("hide");
        cargarUsuarios();
    });
}

// ================== DELETE ==================
function eliminarUsuarioInterno(id){
    crudConfirm("¿Eliminar usuario?")
    .then(ok => {
        if(!ok) return;
        crudDelete(URL_DELETE(id), () => cargarUsuarios());
    });
}

// ================== INIT ==================
$(document).ready(function(){
    cargarUsuarios(1);
});
</script>

{% endblock %}
